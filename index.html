<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MIT CSAIL Visual Computing Seminar</title>
  <meta name="description" content="MIT Visual Computing Seminar — weekly on Tuesdays 12–1PM ET (mostly) at 32-463. Talks, calendar, about, and past speakers." />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <nav class="nav" aria-label="Primary">
      <div class="hero-logos" aria-label="MIT and CSAIL logos">
        <img src="assets/mit.png" alt="MIT logo" style="height: 40px;" />
        <img src="assets/csail.png" alt="MIT CSAIL logo" />
      </div> 
      <!-- <div class="logo">MIT Visual Computing Seminar</div> -->
      <div class="spacer"></div>
      <div class="links">
        <a href="#calendar">Calendar</a>
        <a href="#about">About</a>
        <button class="btn secondary" id="download-ics">Download Calendar</button>
        <button class="iconbtn" id="theme-toggle" type="button" aria-label="Toggle dark mode" aria-pressed="false" title="Toggle dark mode">☀️</button>
      </div>
    </nav>
  </header>

  <section class="hero" id="home">
    <div class="hero-inner">
      <div>
        <span class="tag">Fall 2025</span>
        <h1>MIT Visual Computing Seminar</h1>
        <div class="meta">Tuesdays • 12:00–1:00 PM ET • 32-D463 Star Room, MIT CSAIL</div>
        <div class="cta">
          <a class="btn" href="#calendar">See upcoming talks</a>
          <a class="btn" target="_blank" rel="noopener" href="https://forms.gle/2kiZY5ae2jGbHY4X6">Sign up to give a talk</a>
        </div>
      </div>
      <div class="hero-card" role="complementary" aria-label="Organizers">
        <h3>Organizers</h3>
        <div class="org-list">
          <div class="org">
            <img class="avatar" src="https://www.kushagratiwary.com/images/kush.jpeg" referrerpolicy="no-referrer" decoding="async" loading="lazy" alt="Photo of Kush Tiwary" />
            <div>
              <div class="org-name">Kush Tiwary</div>
              <div class="org-email"><a href="mailto:ktiwary@mit.edu">ktiwary@mit.edu</a></div>
              <div><a href="https://www.kushagratiwary.com/" target="_blank" rel="noopener">kushagratiwary.com</a></div>
            </div>
          </div>
          <div class="org">
            <img class="avatar" src="https://lmattos.com/figures/profile.png" referrerpolicy="no-referrer" decoding="async" loading="lazy" alt="Photo of Leticia Mattos Da Silva" />
            <div>
              <div class="org-name">Leticia Mattos Da Silva</div>
              <div class="org-email"><a href="mailto:leticiam@mit.edu">leticiam@mit.edu</a></div>
              <div><a href="https://lmattos.com/" target="_blank" rel="noopener">lmattos.com</a></div>
            </div>
          </div>
        </div>
        <p style="margin-top:10px; color:#5b5f64;">Have a suggestion? <a href="mailto:ktiwary@mit.edu,leticiam@mit.edu">Email us!</a>!</p>
      </div>
    </div>
  </section>

  <section id="next">
    <div class="container">
      <div id="nextTalkBar" class="nextbar" aria-live="polite">
        <h3 style="margin: 16px 0 10px">Next talk</h3>
        <div id="nextTalk"></div>
      </div>
    </div>
  </section>

  <section id="about" class="about">
    <div class="container">
      <div class="eyebrow">About</div>
      <p>
        The Visual Computing Seminar is a weekly gathering of Vision and Graphics researchers and enthusiasts. The seminar focuses mostly on internal speakers, and lunch is provided.
      </p>
      <p><strong>When:</strong> Tuesdays, 12:00–1:00 PM Eastern Time</p>
      <p><strong>Where:</strong> 32-D463 Star Room, MIT CSAIL (subject to change)</p>
      <p><strong>Format:</strong> 25 or 50 minutes talks</p>
    </div>
  </section>

  <section id="calendar">
    <div class="container">
      <div class="eyebrow">Schedule</div>
      <h2>Calendar</h2>
      <div class="filterbar">
        <input class="input" id="search" placeholder="Keyword search (title, speaker, notes)…" aria-label="Keyword search" />
        <div class="tabs" role="tablist" aria-label="Calendar display">
          <button class="tab" role="tab" aria-selected="true" data-view="list">List</button>
          <button class="tab" role="tab" aria-selected="false" data-view="grid">Calendar</button>
        </div>
        <div class="spacer"></div>
        <div class="monthbar">
          <button class="arrow" id="prevMonth" aria-label="Previous month">◀</button>
          <div class="chip" id="rangeLabel">Loading…</div>
          <button class="arrow" id="nextMonth" aria-label="Next month">▶</button>
          <button class="tab" id="jumpToday" aria-label="Jump to current month">Today</button>
        </div>
      </div>

      <div id="listView" class="list" aria-live="polite"></div>
      <div id="gridView" class="calgrid hide-weekends" hidden aria-live="polite"></div>
    </div>
  </section>

  <footer>
    <div class="container">
      <div>© <span id="year"></span> Visual Computing Seminar • MIT CSAIL • <a href="https://accessibility.mit.edu/" target="_blank" rel="noopener">Accessibility</a></div>
    </div>
  </footer>

  <!-- Event Modal -->
  <div id="eventModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <button type="button" class="modal-close" aria-label="Close" data-close>✕</button>
      <img class="modal-photo" alt="" hidden />
      <h3 class="modal-title"></h3>
      <div class="modal-meta">
        <div class="modal-when"></div>
        <div class="modal-where"></div>
        <div class="modal-who"></div>
      </div>
      <div class="modal-actions">
        <button id="modal-add-ics" class="btn" type="button">Add to Calendar</button>
        <a class="btn modal-recording" href="/">Recording</a>
        <a class="btn modal-link" target="_blank" rel="noopener">Open link</a>
      </div>
    </div>
  </div>

  <script>
    // Some helpers
    const $ = (sel, el=document) => el.querySelector(sel);
    const $$ = (sel, el=document) => [...el.querySelectorAll(sel)];

    const tz = 'America/New_York';
    const locationName = '32-D463 Star Room';

    // Format stuff
    const fmt = new Intl.DateTimeFormat(undefined, { month: 'long', day: 'numeric', year: 'numeric' });
    const fmtMonth = new Intl.DateTimeFormat(undefined, { month: 'long', year: 'numeric' });
    const fmtDow = new Intl.DateTimeFormat(undefined, { weekday: 'short' });
    const fmtTime = new Intl.DateTimeFormat(undefined, { hour: 'numeric', minute: '2-digit', timeZone: tz });

    // Set up a recurring seminar series every Tuesday by default
    function generateTuesdays(start = new Date(), count = 16){
      const events = [];
      const first = new Date(start);
      // Move to next Tuesday
      const day = first.getDay(); // Sunday=0
      const delta = (2 - day + 7) % 7;
      if (delta !== 0) first.setDate(first.getDate() + delta);

      for(let i=0;i<count;i++){
        const d = new Date(first);
        d.setDate(first.getDate() + i*7);
        const startAt = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 16, 0)); // 12:00 ET ≈ 16:00 UTC
        const endAt   = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate(), 17, 0)); // 1 hour
        events.push({
          id: `auto-${d.toISOString().slice(0,10)}`,
          title: 'TBA',
          speaker: 'TBA',
          affiliation: '',
          notes: '',
          startAt, endAt,
          location: locationName,
          url: '',
          photo: '',
          series: '',
          seminar: '',
        });
      }
      return events;
    }

    // We add seminars manually here
    const manual = [
      { date: '2025-09-09', title: 'Kickoff Event', location: '32-D463 Star Room', seminar: false, url: 'https://docs.google.com/presentation/d/1jppimjbEhUpKfYxHUp5sDO6RkALYHzPo4OGUqvYmr-A/edit?usp=sharing', photo: 'https://www.csail.mit.edu/sites/default/files/styles/primary_image/public/2017-08/Stata%20CROPPED_0.jpg?h=a5e20daa&itok=5FsCidwu' },
      { date: '2025-09-16', title: 'Coadjoint Orbits Preserving Fluid Simulation', speaker: 'Sina Nabizadeh', affiliation: 'CSAIL', location: '32-D463 Star Room', seminar: true, long: true, photo: 'https://sinabiz.github.io/images/sina25.jpeg' },
      { date: '2025-09-23', title: 'Verified Scheduling for Optimizing High-Level Tensor Programs', speaker: 'Amanda Liu', affiliation: 'CSAIL', location: '32-D463 Star Room', seminar: true, short: true, photo: 'https://people.csail.mit.edu/lamanda/images/avatar.jpg' },
      { date: '2025-09-30', title: 'A Geometric View of Data Complexity: Efficient Local Intrinsic Dimension Estimation with Diffusion Models', speaker: 'Hamid Kamkari', affiliation: 'CSAIL', location: '32-D507', seminar: true, long: true, photo: 'https://hamidrezakmk.github.io/hamid.png' },
      { date: '2025-10-07', title: 'Scaling World Simulators for Safe Physical Intelligence', speaker: 'Jingkang Wang', affiliation: 'University of Toronto', location: '32-D463 Star Room', seminar: true, long: true, photo: 'https://scholar.googleusercontent.com/citations?view_op=medium_photo&user=c0BTYC4AAAAJ&citpid=7' },
      { date: '2025-10-14', title: '3D Symmetric Tensor Field Topology', speaker: 'Eugene Zhang', affiliation: 'Oregon State University', location: '32-D463 Star Room', seminar: true, long: true, },
      { date: '2025-10-21', title: 'PhysiOpt: Physics-Driven Shape Optimization for 3D Generative Models', speaker: 'Sean Zhan and Clement Jambon',   affiliation: 'CSAIL', location: '32-D507', seminar: true, short: true, photo: 'https://adg.csail.mit.edu/wp-content/uploads/2023/09/sean_lower_res-1024x1024.jpg'},
      { date: '2025-10-28', title: 'TBA', speaker: 'Oliver Gross', affiliation: 'UCSD', location: '32-D463 Star Room', seminar: true, long: true, },
      { date: '2025-11-04', speaker: 'Abe Davis', affiliation: 'Cornell University', location: '32-D507', seminar: true, long: true,  photo: 'https://www.cs.cornell.edu/abe/group/content/groupbios/abe/abe.jpeg'},
      { skip: '2025-11-11', reason: 'Veterans Day' },
      { date: '2025-11-18', title: 'Support Function Parameterization of Convex Hulls for Fast Distance Queries', speaker: 'Anh Truong', affiliation: 'CSAIL', location: '32-D463 Star Room', seminar: true, long: true, photo: 'https://adg.csail.mit.edu/wp-content/uploads/2024/10/anh.jpg' },
      { skip: '2025-11-25', reason: 'Thanksgiving' },
      { date: '2025-12-02', title: 'One String to Pull Them All: Fast Assembly of Curved Structures from Flat Auxetic Linkages', speaker: 'Akib Zaman', affiliation: 'CSAIL', location: '32-D463 Star Room', seminar: true, long: true, photo: 'https://adg.csail.mit.edu/wp-content/uploads/2023/09/akib-scaled-e1694743990993-768x768.jpg' },
      { date: '2025-12-09', title: 'Emergent Circuits and Fundamental Limitations of SoTA VLMs', speaker: 'Raphi Kang', affiliation: 'CSAIL', location: '32-D507', seminar: true, long: true, photo: 'https://scholar.googleusercontent.com/citations?view_op=medium_photo&user=49_WjdIAAAAJ&citpid=2' },
      { skip: '2025-12-16', reason: 'Holiday' },
      { skip: '2025-12-23', reason: 'Holiday' },
      { skip: '2025-12-30', reason: 'Holiday' },
      { skip: '2026-01-06', reason: 'IAP' },
      { skip: '2026-01-13', reason: 'IAP' },
      { skip: '2026-01-20', reason: 'IAP' },
      { skip: '2026-01-27', reason: 'IAP' },
      { skip: '2026-01-27', reason: 'IAP' },
      { skip: '2026-02-03', reason: 'IAP' },
      { skip: '2026-03-24', reason: 'Spring Break' },
    ];

    function applyManual(base){
      const byDate = new Map(base.map(ev => [ev.startAt.toISOString().slice(0,10), ev]));

      for(const m of manual){
        if(m.skip){ byDate.delete(m.skip); continue; }

        if(m.date){
          // if a date declares multiple talks, replace that day with separate events
          if (Array.isArray(m.talks) && m.talks.length){
            byDate.delete(m.date); // remove the auto placeholder
            for(const t of m.talks){

              const [sh, sm] = (t.start || '12:00').split(':').map(Number);
              const [eh, em] = (t.end   || '12:25').split(':').map(Number);

              const startAt = new Date(`${m.date}T${String(sh+4).padStart(2,'0')}:${String(sm).padStart(2,'0')}:00Z`);
              const endAt   = new Date(`${m.date}T${String(eh+4).padStart(2,'0')}:${String(em).padStart(2,'0')}:00Z`);

              const ev = {
                id: `multi-${m.date}-${sh}${sm}`,
                title: t.title || 'TBA',
                speaker: t.speaker || '',
                affiliation: t.affiliation || '',
                notes: t.notes || '',
                startAt, endAt,
                location: m.location || t.location || locationName,
                url: t.url || '',
                photo: t.photo || m.photo || '',
                short: t.short ?? true,
                long: t.long ?? false,
                series: !!m.series,
                seminar: !!m.seminar,
              };
              // Store alongside others for that date
              const bucket = byDate.get(m.date);
              if(bucket){ // shouldn't happen since we deleted, but just in case
                if(Array.isArray(bucket)) bucket.push(ev); else byDate.set(m.date, [bucket, ev]);
              } else {
                // use an array to support multiple events for that key during sorting step
                byDate.set(m.date, [ev]);
              }
            }
            continue;
          }

          // Single event override path
          const ev = byDate.get(m.date);
          if(ev){ Object.assign(ev, m); }
          else {
            const d = new Date(m.date + 'T16:00:00Z');
            const end = new Date(m.date + 'T17:00:00Z');
            byDate.set(m.date, { id: `extra-${m.date}`, title: m.title || 'Special Talk', speaker: m.speaker||'', affiliation: m.affiliation||'', notes: m.notes||'', startAt: d, endAt: end, location: m.location||locationName, url: m.url||'', photo: m.photo||'', series:false});
          }
        }
      }

      // Some entries may be arrays if multiple talks so we need to flatten
      const flat = [];
      for(const val of byDate.values()){
        if(Array.isArray(val)) flat.push(...val); else flat.push(val);
      }
      return flat.sort((a,b)=>a.startAt-b.startAt);
    }


    // Build event data
    const baseEvents = generateTuesdays(new Date(), 22); // tweak the window
    const events = applyManual(baseEvents);

    // Calendar state and rendering
    const state = {
      view: 'list',
      month: new Date(new Date().getFullYear(), new Date().getMonth(), 1),
      q: ''
    };

    const listView = $('#listView');
    const gridView = $('#gridView');

    function rangeLabel(){ return fmtMonth.format(state.month); }

    function eventMatches(ev, q){
      if(!q) return true;
      q = q.toLowerCase();
      return [ev.title, ev.speaker, ev.affiliation, ev.notes].filter(Boolean).some(s => String(s).toLowerCase().includes(q));
    }

    function monthEvents(monthDate){
      const m = monthDate.getMonth(), y = monthDate.getFullYear();
      return events.filter(ev => {
        const d = new Date(ev.startAt);
        return d.getMonth()===m && d.getFullYear()===y && eventMatches(ev, state.q);
      });
    }

    function renderList(){
      listView.innerHTML = '';
      const m = monthEvents(state.month);
      $('#rangeLabel').textContent = rangeLabel();
      if(m.length===0){ listView.innerHTML = `<p style="color:var(--muted)">No talks this month. Try another month or clear search.</p>`; return; }

      const monthBlock = document.createElement('div');
      monthBlock.className = 'month';
      monthBlock.innerHTML = `<h3 style="margin:0 0 12px">${fmtMonth.format(state.month)}</h3>`;

      for(const ev of m){ monthBlock.appendChild(buildEventCard(ev)); }
      listView.appendChild(monthBlock);
    }

    function renderGrid(){
      gridView.innerHTML = '';
      $('#rangeLabel').textContent = rangeLabel();
      const y = state.month.getFullYear();
      const m = state.month.getMonth();

      const first = new Date(y, m, 1);
      const startDow = (first.getDay()+6)%7;
      const daysInMonth = new Date(y, m+1, 0).getDate();

      const head = document.createElement('div');
      head.className = 'head';
      ['Mon','Tue','Wed','Thu','Fri','Sat','Sun'].forEach(d =>{ const c=document.createElement('div'); c.textContent=d; head.appendChild(c); });
      gridView.appendChild(head);

      const cells = document.createElement('div');
      cells.className = 'row';
      const totalCells = Math.ceil((startDow + daysInMonth)/7)*7;
      const today = new Date();
      const todayStr = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
      let todayCell = null;

      for(let i=0;i<totalCells;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        const dayNum = i - startDow + 1;
        if(dayNum>0 && dayNum<=daysInMonth){
          const dateStr = `${y}-${String(m+1).padStart(2,'0')}-${String(dayNum).padStart(2,'0')}`;
          cell.setAttribute('data-date', dateStr);
          cell.innerHTML = `<span class="d">${dayNum}</span>`;
          if(dateStr === todayStr){ cell.classList.add('today'); todayCell = cell; }
          const todays = events.filter(ev=>{
            const ds = ev.startAt.toISOString().slice(0,10);
            return ds===dateStr && eventMatches(ev, state.q);
          });
          for(const ev of todays){
            const d = new Date(ev.startAt);
            const end = new Date(ev.endAt);
            const chip = document.createElement('button');
            chip.type = 'button';
            chip.className = 'chip-event';
            chip.textContent = `${fmtTime.format(d)} ET ${ev.title}`;
            const desc = `${ev.speaker||''} ${ev.affiliation?('— '+ev.affiliation):''}\n${fmt.format(d)} · ${fmtTime.format(d)}–${fmtTime.format(end)} ET · ${ev.location||locationName}`;
            chip.title = desc.trim();
            chip.setAttribute('aria-label', `${ev.title} on ${fmt.format(d)} at ${fmtTime.format(d)} ET`);
            chip.addEventListener('click', ()=> openEventModal(ev));
            cell.appendChild(chip);
          }
        }
        cells.appendChild(cell);
      }
      gridView.appendChild(cells);

      // If showing the current month, scroll today's week into view
      const isCurrentMonth = y===today.getFullYear() && m===today.getMonth();
      if(isCurrentMonth && todayCell){ todayCell.scrollIntoView({behavior:'smooth', block:'center'}); }
    }

    function render(){
      if(state.view==='list'){
        listView.hidden = false; gridView.hidden = true; renderList();
      } else {
        listView.hidden = true; gridView.hidden = false; renderGrid();
      }
    }

    // Simple modal to show event details
    function openEventModal(ev){
      const d = new Date(ev.startAt);
      const end = new Date(ev.endAt);
      const modal = document.getElementById('eventModal');
      if(!modal) return;
      modal.querySelector('.modal-title').textContent = ev.title || 'Seminar';
      modal.querySelector('.modal-when').textContent = `${fmt.format(d)} · ${fmtTime.format(d)}–${fmtTime.format(end)} ET`;
      modal.querySelector('.modal-who').textContent = [ev.speaker, ev.affiliation].filter(Boolean).join(' — ');
      const whereEl = modal.querySelector('.modal-where');
      const loc = ev.location || locationName;
      const mapsHref = 'https://www.google.com/maps?q=MIT+Building+32';
      whereEl.innerHTML = `${loc} · <a href="${mapsHref}" target="_blank" rel="noopener">Map</a>`;
      const photo = modal.querySelector('.modal-photo');
      if(ev.photo){ photo.src = ev.photo; photo.hidden = false; } else { photo.hidden = true; }
      const link = modal.querySelector('.modal-link');
      if(ev.url){ link.href = ev.url; link.hidden = false; } else { link.hidden = true; }
      const addBtn = modal.querySelector('#modal-add-ics');
      addBtn.onclick = ()=> downloadICS([ev], `vcs-${ev.startAt.toISOString().slice(0,10)}.ics`);
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
      // focus for accessibility
      modal.querySelector('.modal-close').focus();
    }

    function closeEventModal(){
      const modal = document.getElementById('eventModal');
      if(!modal) return;
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }

    // Modal interactions
    (function attachModalHandlers(){
      const modal = document.getElementById('eventModal');
      if(!modal) return;
      modal.addEventListener('click', (e)=>{
        if(e.target === modal || e.target.hasAttribute('data-close')) closeEventModal();
      });
      document.addEventListener('keydown', (e)=>{
        if(e.key === 'Escape') closeEventModal();
      });
    })();

    // Build a reusable event card node for list and next talk
    function buildEventCard(ev){
      const d = new Date(ev.startAt);
      const end = new Date(ev.endAt);
      const hasPhoto = ev.photo && ev.photo.trim() !== '';
      const node = document.createElement('article');
      node.className = 'event';
      node.innerHTML = `
        <div class="date ${hasPhoto ? 'has-photo' : ''}">
          ${hasPhoto ? `<img class=\"date-photo\" src=\"${ev.photo}\" alt=\"${ev.speaker ? `Photo of ${ev.speaker}` : 'Speaker photo'}\" />` : ''}
          <div class="date-overlay">
            <div class="dow">${fmtDow.format(d)}</div>
            <div class="day">${d.getDate()}</div>
          </div>
        </div>
        <div>
          <h4>${ev.title}</h4>
          <div class="meta">${ev.speaker || ''}${ev.affiliation?` •  ${ev.affiliation}`:''}</div>
          <div class="meta">${fmt.format(d)} · ${fmtTime.format(d)}–${fmtTime.format(end)} ET · ${ev.location || locationName} · <a href="https://www.google.com/maps?q=MIT+Building+32" target="_blank" rel="noopener">Map</a></div>
          ${ev.notes?`<div class="meta" style="margin-top:4px">${ev.notes}</div>`:''}
          <div class="tags">
            <span class="pill">Seminar</span>
            ${ev.series?'<span class="pill" style="border-color:var(--honey)">Series</span>':''}
            ${ev.long?'<span class="pill" style="border-color:var(--honey)">50 minutes</span>':''}
            ${ev.short?'<span class="pill" style="border-color:var(--honey)">25 minutes</span>':''}
          </div>
          <div class="actions">
            <button class="btn add-ics-btn">Add to Calendar</button>
            <a class="btn" href="/">Recording</a>
            ${ev.url?`<a class="btn" target="_blank" rel="noopener" href="${ev.url}">Details</a>`:''}
          </div>
        </div>`;
      const addIcs = node.querySelector('.actions .add-ics-btn');
      if(addIcs){ addIcs.addEventListener('click', ()=> downloadICS([ev], 'visual-computing-seminar.ics')); }
      return node;
    }

    // .ics download 
    function toICSDate(d){
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      const HH = String(d.getUTCHours()).padStart(2,'0');
      const MM = String(d.getUTCMinutes()).padStart(2,'0');
      const SS = '00';
      return `${yyyy}${mm}${dd}T${HH}${MM}${SS}Z`;
    }

    function icsFor(events){
      const lines = [
        'BEGIN:VCALENDAR','VERSION:2.0','PRODID:-//MIT CSAIL//Visual Computing Seminar//EN'
      ];
      for(const ev of events){
        const uid = ev.id || (ev.title + '-' + ev.startAt.toISOString());
        lines.push('BEGIN:VEVENT');
        lines.push(`UID:${uid}`);
        lines.push(`DTSTAMP:${toICSDate(new Date())}`);
        lines.push(`DTSTART:${toICSDate(ev.startAt)}`);
        lines.push(`DTEND:${toICSDate(ev.endAt)}`);
        lines.push(`SUMMARY:${escapeICS(ev.title)}`);
        const descParts = [ev.speaker?`Speaker: ${ev.speaker}`:null, ev.affiliation, ev.notes].filter(Boolean);
        lines.push(`DESCRIPTION:${escapeICS(descParts.join(' — '))}`);
        lines.push(`LOCATION:${escapeICS(ev.location || locationName)}`);
        if(ev.url) lines.push(`URL:${ev.url}`);
        lines.push('END:VEVENT');
      }
      lines.push('END:VCALENDAR');
      return lines.join('\r\n');
    }
    function escapeICS(s){
      return String(s).replace(/[\\;,\n]/g, ch=> ({'\\':'\\\\',';':'\\;','\n':'\\n',',':'\\,'}[ch])).replace(/\r/g,'');
    }
    function download(filename, text){
      const blob = new Blob([text], {type:'text/calendar'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename; a.click();
      setTimeout(()=> URL.revokeObjectURL(url), 1000);
    }
    function downloadICS(evts, name){ download(name, icsFor(evts)); }

    // Controls
    $('#year').textContent = new Date().getFullYear();

    $$('.tab[role="tab"]').forEach(btn=>btn.addEventListener('click', e=>{
      $$('.tab[role="tab"]').forEach(b=>b.setAttribute('aria-selected','false'));
      e.currentTarget.setAttribute('aria-selected','true');
      state.view = e.currentTarget.dataset.view;
      render();
    }));
    $('#prevMonth').addEventListener('click', ()=>{ state.month = new Date(state.month.getFullYear(), state.month.getMonth()-1, 1); render(); });
    $('#nextMonth').addEventListener('click', ()=>{ state.month = new Date(state.month.getFullYear(), state.month.getMonth()+1, 1); render(); });
    $('#jumpToday').addEventListener('click', ()=>{ state.month = new Date(new Date().getFullYear(), new Date().getMonth(), 1); render(); });

    $('#search').addEventListener('input', e=>{ state.q = e.target.value.trim(); render(); });

    $('#download-ics').addEventListener('click', ()=> downloadICS(events, 'visual-computing-seminar-series.ics'));
    const addNextBtn = $('#add-next');
    if(addNextBtn){
      addNextBtn.addEventListener('click', ()=>{
        const now = new Date();
        const next = events.find(e=>e.endAt>now);
        if(next) downloadICS([next], `vcs-${next.startAt.toISOString().slice(0,10)}.ics`);
      });
    }

    // Theme toggle (light/dark) with persistence
    (function initTheme(){
      const root = document.documentElement;
      const btn = document.getElementById('theme-toggle');
      const stored = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      let theme = stored || (prefersDark ? 'dark' : 'light');
      applyTheme(theme);
      if(btn){
        btn.addEventListener('click', ()=>{
          theme = (root.getAttribute('data-theme') === 'dark') ? 'light' : 'dark';
          applyTheme(theme);
          localStorage.setItem('theme', theme);
        });
      }
      function applyTheme(t){
        root.setAttribute('data-theme', t);
        if(btn){
          const isDark = t === 'dark';
          btn.setAttribute('aria-pressed', String(isDark));
          btn.textContent = isDark ? '🌙' : '☀️';
          btn.title = isDark ? 'Switch to light mode' : 'Switch to dark mode';
        }
      }
    })();

    // Render Next Talk bar
    (function renderNextTalk(){
      const now = new Date();
      const next = events.find(e=>e.endAt>now);
      const mount = document.getElementById('nextTalk');
      if(!next || !mount) return;
      mount.innerHTML = '';
      mount.appendChild(buildEventCard(next));
    })();

    render();
  </script>
</body>
</html>
